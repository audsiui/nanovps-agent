name: Release Build

# 触发条件：当你推送以 'v' 开头的 tag 时 (例如 v1.0.0, v0.1.beta)
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build & Release
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 安装 Bun 环境
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # 3. 安装依赖
      - name: Install dependencies
        run: bun install

      # 4. 创建 dist 目录 (防止 bun build 找不到目录报错)
      - name: Create dist directory
        run: mkdir -p dist

      # 5. 执行打包 (调用 package.json 里的 scripts)
      - name: Build for Linux AMD64
        run: bun run build:linux-x64

      - name: Build for Linux ARM64
        run: bun run build:linux-arm64

      # 6. 生成 Release 并上传附件
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # 自动把 dist 目录下的这两个文件上传到 Release
          files: |
            dist/nanovps-agent-linux-amd64
            dist/nanovps-agent-linux-arm64
          # 是否设为草稿 (false 表示直接发布)
          draft: false
          # 是否设为预发布 (如果 tag 包含 beta/alpha 自动设为 true，否则 false)
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}